import fs from 'node:fs';
import path from 'node:path';

import fetch from 'node-fetch';

const plugins = {
  'Platform Init': 'soundworks-plugin-platform-init/main',
  'Position': 'soundworks-plugin-position/v4',
  'Filesystem': 'soundworks-plugin-filesystem/v4',
  'Scripting': 'soundworks-plugin-scripting/v4',
};

// // github urls are in the form
// // https://raw.githubusercontent.com/collective-soundworks/soundworks-plugin-position/v4/README.md

const sortedKeys = Object.keys(plugins).sort();

const menuEntries = [];

for (let pluginName of sortedKeys) {
  const plugin = plugins[pluginName];
  const url = `https://raw.githubusercontent.com/collective-soundworks/${plugin}/README.md`;
  const res = await fetch(url);
  const readme = await res.text();

  const filename = plugin
    .replace('soundworks-plugin-', '')
    .replace(/\/.*/g, '');
  const pathname = path.join('plugins', `${filename}.md`);
  fs.writeFileSync(pathname, readme);

  menuEntries.push({
    text: pluginName,
    link: `/plugins/${filename}`,
  });
}

const sidebarContent = `\
// file generated by .bin/download-plugins-readme.js
export default {
  text: 'Plugins',
  items: ${JSON.stringify(menuEntries, null, 2)},
};
`;

const sidebarPathname = path.join('.vitepress', 'sidebar-plugins.js');
fs.writeFileSync(sidebarPathname, sidebarContent);
